#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define HEADER_SIZE 192
#define LOGO_OFFSET 4
#define LOGO_SIZE 156
#define TITLE_OFFSET 0xA0
#define CODE_OFFSET  0xAC
#define MAKER_OFFSET 0xB0
#define CHKSUM_OFFSET 0xBD

static const uint8_t logo[LOGO_SIZE] = {
  0x24,0xFF,0xAE,0x51,0x69,0x9A,0xA2,0x21,0x3D,0x84,0x82,0x0A,0x84,0xE4,0x09,0xAD,
  0x11,0x24,0x8B,0x98,0xC0,0x81,0x7F,0x21,0xA3,0x52,0xBE,0x19,0x93,0x09,0xCE,0x20,
  0x10,0x46,0x4A,0x4A,0xF8,0x27,0x31,0xEC,0x58,0xC7,0xE8,0x33,0x82,0xE3,0xCE,0xBF,
  0x85,0xF4,0xDF,0x94,0xCE,0x4B,0x09,0xC1,0x94,0x56,0x8A,0xC0,0x13,0x72,0xA7,0xFC,
  0x9F,0x84,0x4D,0x73,0xA3,0xCA,0x9A,0x61,0x58,0x97,0xA3,0x27,0xFC,0x03,0x98,0x76,
  0x23,0x1D,0xC7,0x61,0x03,0x04,0xAE,0x56,0xBF,0x38,0x84,0x00,0x40,0xA7,0x0E,0xFD,
  0xFF,0x52,0xFE,0x03,0x6F,0x95,0x30,0xF1,0x97,0xFB,0xC0,0x85,0x60,0xD6,0x80,0x25,
  0xA9,0x63,0xBE,0x03,0x01,0x4E,0x38,0xE2,0xF9,0xA2,0x34,0xFF,0xBB,0x3E,0x03,0x44,
  0x78,0x00,0x90,0xCB,0x88,0x11,0x3A,0x94,0x65,0xC0,0x7C,0x63,0x87,0xF0,0x3C,0xAF,
  0xD6,0x25,0xE4,0x8B,0x38,0x0A,0xAC,0x72,0x21,0xD4,0xF8,0x07
};

static void patch_header(uint8_t *rom, const char *title, const char *code, const char *maker) {
    memset(&rom[TITLE_OFFSET], ' ', 12);
    strncpy((char *)&rom[TITLE_OFFSET], title, 12);
    strncpy((char *)&rom[CODE_OFFSET], code, 4);
    strncpy((char *)&rom[MAKER_OFFSET], maker, 2);
    rom[0xB2] = 0x96;
    rom[0xB3] = 0x00;
    rom[0xB4] = 0x00;
    memset(&rom[0xB5], 0x00, 7);
    rom[0xBC] = 0x00;

    uint8_t sum = 0;
    for (int i = 0xA0; i <= 0xBC; ++i) sum -= rom[i];
    rom[CHKSUM_OFFSET] = sum;

    memcpy(&rom[LOGO_OFFSET], logo, LOGO_SIZE);
}

int main(int argc, char **argv) {
    if (argc != 6) {
        fprintf(stderr, "Usage: %s input.elf output.gba TITLE CODE MAKER\n", argv[0]);
        return 1;
    }

    const char *inelf = argv[1];
    const char *outgba = argv[2];
    const char *title = argv[3];
    const char *code = argv[4];
    const char *maker = argv[5];

    char tmpbin[] = "elf2gba_tmpXXXXXX";
    int tmpfd = mkstemp(tmpbin);
    if (tmpfd == -1) { perror("mkstemp"); return 1; }
    close(tmpfd);

    char cmd[256];
    snprintf(cmd, sizeof(cmd), "arm-none-eabi-objcopy -O binary \"%s\" \"%s\"", inelf, tmpbin);
    if (system(cmd) != 0) {
        fprintf(stderr, "objcopy failed\n");
        unlink(tmpbin);
        return 1;
    }

    FILE *f = fopen(tmpbin, "rb");
    if (!f) { perror("fopen tmp"); unlink(tmpbin); return 1; }
    fseek(f, 0, SEEK_END);
    long len = ftell(f);
    rewind(f);

    // Pad to at least 192 bytes and 4-byte alignment
    long outlen = len < HEADER_SIZE ? HEADER_SIZE : (len + 3) & ~3;

    uint8_t *rom = calloc(1, outlen);
    if (!rom) { perror("calloc"); fclose(f); unlink(tmpbin); return 1; }

    fread(rom, 1, len, f);
    fclose(f);

    patch_header(rom, title, code, maker);

    FILE *out = fopen(outgba, "wb");
    if (!out) { perror("fopen out"); free(rom); unlink(tmpbin); return 1; }
    fwrite(rom, 1, outlen, out);
    fclose(out);
    free(rom);
    unlink(tmpbin);
    return 0;
}
